<!DOCTYPE html>
<html>
    <head>
        <title>Tank Control Using WebSockets</title>
        <style type="text/css">
            body {
                font-family: "Courier New", sans-serif;
                text-align: center;
            }
            .buttons {
                font-size: 4em;
                display: flex;
                justify-content: center;
            }
            .button, .value {
                line-height: 1;
                padding: 2rem;
                margin: 2rem;
                border: medium solid;
                min-height: 1em;
                min-width: 1em;
            }
            .button {
                cursor: pointer;
                user-select: none;
            }
            .minus {
                color: red;
            }
            .plus {
                color: green;
            }
            .value {
                min-width: 2em;
            }
            .state {
                font-size: 2em;
            }

            
        </style>
        <script>
            var serverAddress; // = '10.13.7.79'
            var websocket; // = new WebSocket("ws://" + serverAddress + ":5678/");
            
            document.addEventListener ('DOMContentLoaded', function () { 
               console.log ( 'Adding mouse down/up Listeners' );
               document.getElementById ("forward").addEventListener ("mousedown", forward);
               document.getElementById ("forward").addEventListener ("mouseup", stop);
               document.getElementById ("reverse").addEventListener ("mousedown", reverse);
               document.getElementById ("reverse").addEventListener ("mouseup", stop);
               document.getElementById ("left"   ).addEventListener ("mousedown", left);
               document.getElementById ("left"   ).addEventListener ("mouseup", stop);
               document.getElementById ("right"  ).addEventListener ("mousedown", right);
               document.getElementById ("right"  ).addEventListener ("mouseup", stop);
               document.getElementById ("fire"   ).addEventListener ("mousedown", fire);
               document.getElementById ("connectToServer" ).addEventListener ("mousedown", serverConnect);
               document.getElementById ("connectCamera" ).addEventListener ("mousedown", cameraConnect);
            });     
            
            function cameraConnect() {
              var cameraFrame = document.getElementById ( 'cameraFrame')
              var address = 'http://' + document.all.cameraAddress.value + ':81/stream';
              console.log ( 'New Address: ' + address)
              cameraFrame.src = address;
            }
            
            function serverConnect () {
               if (serverAddress == undefined) {
                  serverAddress = document.all.ipAddress.value; // '10.13.7.79'
                  websocket = new WebSocket("ws://" + serverAddress + ":5678/");
                  
                  websocket.onmessage = function (event) {
                      users = document.querySelector('.users');
                      value = document.querySelector('.value');
                     
                      data = JSON.parse(event.data);
                      switch (data.type) {
                          case 'state':
                              //value.textContent = data.value;
                              break;
                          case 'users':
                              users.textContent = (
                                  data.count.toString() + " user" +
                                  (data.count == 1 ? "" : "s"));
                              break;
                          default:
                              console.error(
                                  "unsupported event", data);
                      }
                  };                  
               }
            }

            function sendData (msg) {
              console.log ( 'sendData [' + msg + ']');
              websocket.send(JSON.stringify({action: msg}));              
            }
            function left() {
               sendData ('left');
            }
            function right(){
               sendData ('right');
            }
            function forward () {
               sendData ('forward');
            }
            function reverse() {
               sendData ('reverse');
            }
            function stop() {
               sendData ('stop');
            }
            function fire() {
               sendData ('fire');
            }       
        </script>
      </head>
    <body>
      <div style="float:center">
      <p>
      <hr>

          <p>
            Note: For best frame rate, use vga 640x480<br>
            Camera Ip Address: http://<input value="192.168.0.231" id="cameraAddress">:81/stream<input type="button" value="connect" id="connectCamera"><br>
           
            Server Ip Address: <input value='192.168.0.75' id="ipAddress">:5678<input type="button" value="connect" id="connectToServer">
         
            <div class="state">
              <span class="users">?</span> online
            </div>
            See <a href="https://websockets.readthedocs.io/en/stable/intro.html">https://websockets.readthedocs.io/en/stable/intro.html</a> for more info.
            <hr>            
       </div    
      <div>
          <div style="float:left">
              <iframe src="http://192.168.0.231:81/stream" width="640px" height="480px" id="cameraFrame"></iframe>     
          </div>
          <div style="float:center">
              <img src="images/forward.jpg" id="forward" width="100px"> 
              <br>
              <img src="images/left.jpg" id="left" width="100px"> 
              <img src="images/right.jpg" id="right" width="100px"> 
              <br>
              <img src="images/reverse.jpg" id="reverse" width="100px">
              <br>
              <img src="images/fire.jpg" id="fire" width="100px">
          </div>
      </div> 

      
   </body>
</html>